@startuml
actor User
participant "Client\nComputer" as Client
participant "Domain Controller\n(KDC / Auth Server)" as KDC
participant "Application\nServer" as AppServer

User -> Client: Log in
Client -> KDC: AS-REQ with Timestamp encrypted by User's Username+Password Hash
KDC -> KDC: Verify Timestamp and User's Password Hash (ntds.dit)
KDC --> Client: AS-REP with Session Key (encrypted with user password) and TGT (encrypted with KDC's Secret Key)
note right
    If decryption is ok and
    timestamp is not a duplicate (replay attack)
end note
Client -> Client: Decrypt Session Key with User's Password Hash
Client -> KDC: TGS-REQ with username, Resource Name, Encrypted TGT, and Timestamp
KDC -> KDC: Decrypt TGT, Verify Timestamp, Resource and User Info
note left
    1. TGT must have a valid timestamp
    2. Username from TGS-REQ has to match username from TGT
    3. Client IP has to match TGT IP
end note
KDC --> Client: TGS-REP with Service Name, Session Key, and Encrypted Service Ticket
Client -> AppServer: AP-REQ with Encrypted Username, Timestamp, and Service Ticket
AppServer -> AppServer: Decrypt Service Ticket, Verify Username and Session Key
AppServer --> Client: Grant Access to Service
@enduml
